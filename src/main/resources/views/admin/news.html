<div th:replace="~{layouts/authLayout :: layout('Tin tức', ~{::content})}">
  <div th:fragment="content">
    <div class="bg-white rounded-lg p-6">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Danh sách tin tức</h1>
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
          <i class="fas fa-plus mr-2"></i>Thêm tin tức
        </button>
      </div>

      <div class="mb-6">
        <div class="flex items-center space-x-4">
          <div class="flex-1">
            <input
              type="text"
              placeholder="Tìm kiếm tin tức..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
            <i class="fas fa-filter mr-2"></i>Lọc
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full flex justify-center items-center py-12">
          <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
            <p class="text-gray-600">Đang tải tin tức...</p>
          </div>
        </div>
      </div>

      <!-- Error State -->
      <div id="errorState" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        <div class="col-span-full flex justify-center items-center py-12">
          <div class="text-center">
            <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Lỗi tải dữ liệu</h3>
            <p class="text-gray-500 mb-4">Không thể tải danh sách tin tức</p>
            <button id="retryLoad" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors">
              <i class="fas fa-redo mr-2"></i>Thử lại
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        <div class="col-span-full flex justify-center items-center py-12">
          <div class="text-center">
            <i class="fas fa-newspaper text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">Chưa có tin tức nào</h3>
            <p class="text-gray-500 mb-4">Hãy thêm tin tức đầu tiên để bắt đầu</p>
            <button id="addFirstNews" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-plus mr-2"></i>Thêm tin tức đầu tiên
            </button>
          </div>
        </div>
      </div>

      <!-- News Grid -->
      <div id="newsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
        <!-- News items will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>

<script>
// API Configuration
const API_BASE_URL = '/api/news-posts';

// Initialize app when DOM is ready
$(document).ready(function() {
    console.log('News page initialized');
    loadNews();
    setupEventListeners();
});

// Setup event listeners
function setupEventListeners() {
    // Retry button
    $('#retryLoad').click(function(e) {
        e.preventDefault();
        loadNews();
    });
    
    // Add first news button
    $('#addFirstNews').click(function(e) {
        e.preventDefault();
        showToast('Module đang phát triển', 'info');
    });
    
    // Add news button
    $('button:contains("Thêm tin tức")').click(function(e) {
        e.preventDefault();
        showToast('Module đang phát triển', 'info');
    });
    
    // Search functionality
    $('input[placeholder="Tìm kiếm tin tức..."]').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        searchNews(searchTerm);
    });
}

// Load news from API
function loadNews() {
    console.log('Loading news from API:', API_BASE_URL);
    
    // Show loading state
    showLoadingState();
    
    $.ajax({
        url: API_BASE_URL,
        method: 'GET',
        success: function(result) {
            console.log('News loaded:', result);
            
            if (result.success && result.data && result.data.items && result.data.items.length > 0) {
                // Filter out deleted news
                const activeNews = result.data.items.filter(news => !news.deletedAt);
                console.log('Active news count:', activeNews.length);
                
                if (activeNews.length > 0) {
                    displayNews(activeNews);
                } else {
                    showEmptyState();
                }
            } else {
                console.log('No news found, showing empty state');
                showEmptyState();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading news:', error);
            showErrorState();
        }
    });
}

// Display news in grid
function displayNews(newsList) {
    console.log('Displaying news:', newsList);
    
    const $grid = $('#newsGrid');
    let html = '';
    
    newsList.forEach(news => {
        const createdDate = news.createdAt ? new Date(news.createdAt).toLocaleDateString('vi-VN') : 'N/A';
        const excerpt = news.content ? news.content.substring(0, 100) + '...' : 'Không có nội dung';
        
        html += `
            <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow">
                <div class="h-48 bg-gray-200 flex items-center justify-center">
                    <i class="fas fa-image text-4xl text-gray-400"></i>
                </div>
                <div class="p-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${news.title || 'Không có tiêu đề'}</h3>
                    <p class="text-gray-600 text-sm mb-3">${excerpt}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">${createdDate}</span>
                        <div class="flex space-x-2">
                            <button onclick="editNews('${news.id}')" class="text-blue-600 hover:text-blue-900 text-sm">Sửa</button>
                            <button onclick="deleteNews('${news.id}')" class="text-red-600 hover:text-red-900 text-sm">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    $grid.html(html);
    showNewsGrid();
}

// Show different states
function showLoadingState() {
    $('#loadingState').removeClass('hidden');
    $('#errorState, #emptyState, #newsGrid').addClass('hidden');
}

function showErrorState() {
    $('#errorState').removeClass('hidden');
    $('#loadingState, #emptyState, #newsGrid').addClass('hidden');
}

function showEmptyState() {
    $('#emptyState').removeClass('hidden');
    $('#loadingState, #errorState, #newsGrid').addClass('hidden');
}

function showNewsGrid() {
    $('#newsGrid').removeClass('hidden');
    $('#loadingState, #errorState, #emptyState').addClass('hidden');
}

// Search news
function searchNews(searchTerm) {
    const $newsItems = $('#newsGrid .bg-white');
    
    $newsItems.each(function() {
        const $item = $(this);
        const title = $item.find('h3').text().toLowerCase();
        const content = $item.find('p').text().toLowerCase();
        
        if (title.includes(searchTerm) || content.includes(searchTerm)) {
            $item.show();
        } else {
            $item.hide();
        }
    });
}

// News actions (placeholder functions)
function editNews(newsId) {
    console.log('Edit news:', newsId);
    showToast('Module đang phát triển', 'info');
}

function deleteNews(newsId) {
    console.log('Delete news:', newsId);
    showToast('Module đang phát triển', 'info');
}

// Toast notification
function showToast(message, type = 'info') {
    const toastClass = {
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500',
        'info': 'bg-blue-500'
    }[type] || 'bg-blue-500';
    
    const toast = $(`
        <div class="fixed top-4 right-4 ${toastClass} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300">
            <div class="flex items-center">
                <i class="fas fa-info-circle mr-2"></i>
                <span>${message}</span>
            </div>
        </div>
    `);
    
    $('body').append(toast);
    
    // Slide in
    setTimeout(() => {
        toast.removeClass('translate-x-full');
    }, 100);
    
    // Slide out after 3 seconds
    setTimeout(() => {
        toast.addClass('translate-x-full');
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}
</script>
