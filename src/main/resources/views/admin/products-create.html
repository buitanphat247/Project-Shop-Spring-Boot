<div th:replace="~{layouts/authLayout :: layout('Thêm sản phẩm', ~{::content})}">
  <div th:fragment="content">
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Thêm sản phẩm mới</h1>
        <p class="text-gray-600 mt-2">Điền thông tin để tạo sản phẩm mới</p>
      </div>

      <form class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tên sản phẩm</label>
            <input
              type="text"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors no-scale"
              placeholder="Nhập tên sản phẩm"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Giá</label>
            <input
              type="number"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors no-scale"
              placeholder="Nhập giá sản phẩm"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Danh mục</label>
            <select id="categorySelect" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors no-scale">
              <option value="">Đang tải danh mục...</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Số lượng</label>
            <input
              type="number"
              class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors no-scale"
              placeholder="Nhập số lượng"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Mô tả</label>
          <textarea
            rows="4"
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none transition-colors no-scale"
            placeholder="Nhập mô tả sản phẩm"
          ></textarea>
        </div>

        <!-- Product Attributes Section -->
        <div>
          <div class="flex items-center justify-between mb-4">
            <label class="block text-sm font-medium text-gray-700">Thuộc tính sản phẩm</label>
            <button type="button" id="addAttributeBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
              <i class="fas fa-plus mr-2"></i>Thêm thuộc tính
            </button>
          </div>
          
          <div id="attributesContainer" class="space-y-3">
            <!-- Default attribute will be added here -->
          </div>
          
          <!-- Template for new attribute (hidden) -->
          <div id="attributeTemplate" class="hidden">
            <div class="attribute-item flex items-center space-x-3 p-4 border border-gray-200 rounded-lg bg-white">
              <div class="flex-1">
                <input
                  type="text"
                  placeholder="Tên thuộc tính (VD: Màu sắc, Kích thước, Chất liệu...)"
                  class="w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:border-blue-500 focus:outline-none transition-colors text-sm no-scale"
                />
              </div>
              <div class="flex-1">
                <input
                  type="text"
                  placeholder="Giá trị (VD: Đỏ, XL, Cotton...)"
                  class="w-full px-3 py-2 border-2 border-gray-300 rounded-md focus:border-blue-500 focus:outline-none transition-colors text-sm no-scale"
                />
              </div>
              <button type="button" class="remove-attribute-btn px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Hình ảnh</label>
          <div class="relative">
            <input type="file" id="imageInput" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 hover:bg-blue-50 transition-colors">
              <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
              <p class="text-gray-600">Kéo thả hình ảnh vào đây hoặc click để chọn</p>
              <p class="text-sm text-gray-500 mt-2">Có thể chọn nhiều hình ảnh cùng lúc</p>
            </div>
          </div>
          
          <!-- Image Preview Container -->
          <div id="imagePreviewContainer" class="mt-6 hidden">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-2">
                <i class="fas fa-images text-blue-500"></i>
                <h4 class="text-sm font-medium text-gray-700">Hình ảnh đã chọn</h4>
                <span id="imageCount" class="bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full">0</span>
              </div>
              <button type="button" id="clearAllImages" class="flex items-center space-x-1 px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 rounded-lg transition-colors text-sm font-medium">
                <i class="fas fa-trash text-xs"></i>
                <span>Xóa tất cả</span>
              </button>
            </div>
            <div id="imagePreviewGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
              <!-- Image previews will be added here -->
            </div>
          </div>
        </div>

        <div class="flex justify-end space-x-4">
          <button type="button" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">Hủy</button>
          <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
            <i class="fas fa-save mr-2"></i>Lưu sản phẩm
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- CSS for animations -->
<style>
  /* Custom animations */
  @keyframes slideIn {
    from { 
      opacity: 0; 
      transform: translateY(-10px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }
  
  @keyframes slideOut {
    from { 
      opacity: 1; 
      transform: translateY(0); 
    }
    to { 
      opacity: 0; 
      transform: translateY(-10px); 
    }
  }
  
  .attribute-item {
    animation: slideIn 0.3s ease-out;
  }
  
  .attribute-item.removing {
    animation: slideOut 0.3s ease-in;
  }
  
  /* Override global input focus scale for no-scale class */
  input.no-scale:focus,
  select.no-scale:focus,
  textarea.no-scale:focus {
    transform: none !important;
  }
</style>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>

<!-- Product Create JavaScript -->
<script>
$(document).ready(function() {
    console.log('Product create page loaded');
    
    let attributeCount = 0;
    
    // Load categories on page load
    loadCategories();
    
    // Add default attribute on page load
    addNewAttribute();
    
    // Initialize image upload
    initImageUpload();
    
    // Add attribute button click
    $('#addAttributeBtn').click(function(e) {
        e.preventDefault();
        console.log('Add attribute button clicked');
        addNewAttribute();
    });
    
    // Remove attribute button click (delegated event)
    $(document).on('click', '.remove-attribute-btn', function(e) {
        e.preventDefault();
        console.log('Remove attribute button clicked');
        const $attributeItem = $(this).closest('.attribute-item');
        removeAttribute($attributeItem);
    });
    
    // Form submit
    $('form').submit(function(e) {
        e.preventDefault();
        console.log('Form submitted');
        handleFormSubmit();
    });
    
    // Add new attribute function
    function addNewAttribute() {
        const $template = $('#attributeTemplate');
        const $container = $('#attributesContainer');
        
        // Clone the template
        const $newAttribute = $template.clone().removeClass('hidden');
        
        // Add unique IDs to inputs
        attributeCount++;
        const keyId = 'attr_key_' + attributeCount;
        const valueId = 'attr_value_' + attributeCount;
        
        $newAttribute.find('input').first().attr('id', keyId).attr('name', 'attributes[' + attributeCount + '].key');
        $newAttribute.find('input').last().attr('id', valueId).attr('name', 'attributes[' + attributeCount + '].value');
        
        // Add to container with animation
        $container.append($newAttribute);
        
        // Don't auto focus on first input
        // $newAttribute.find('input').first().focus();
        
        console.log('New attribute added, count:', attributeCount);
    }
    
    // Remove attribute function
    function removeAttribute($attributeItem) {
        console.log('Removing attribute');
        
        // Add removing class for animation
        $attributeItem.addClass('removing');
        
        // Remove after animation
        setTimeout(function() {
            $attributeItem.remove();
            console.log('Attribute removed');
        }, 300);
    }
    
    // Handle form submit
    function handleFormSubmit() {
        console.log('Handling form submit');
        
        // Collect form data
        const formData = {
            name: $('input[placeholder="Nhập tên sản phẩm"]').val(),
            price: parseFloat($('input[placeholder="Nhập giá sản phẩm"]').val()),
            stock: parseInt($('input[placeholder="Nhập số lượng"]').val()),
            description: $('textarea[placeholder="Nhập mô tả sản phẩm"]').val(),
            categoryId: $('#categorySelect').val(),
            attributes: []
        };
        
        // Collect attributes
        $('.attribute-item').each(function() {
            const $item = $(this);
            const key = $item.find('input').first().val().trim();
            const value = $item.find('input').last().val().trim();
            
            if (key && value) {
                formData.attributes.push({
                    key: key,
                    value: value
                });
            }
        });
        
        // Add images to form data
        const imageFiles = Array.from($('#imageInput')[0].files);
        formData.images = imageFiles.map(file => ({
            name: file.name,
            size: file.size,
            type: file.type,
            lastModified: file.lastModified,
            file: file // Include the actual file object
        }));
        
        // Also add raw files array for easier access
        formData.imageFiles = imageFiles;
        
        console.log('=== FORM SUBMIT DATA ===');
        console.log('Raw form data:', formData);
        console.log('JSON formatted (without files):');
        
        // Create a copy without file objects for JSON display
        const jsonData = {
            name: formData.name,
            price: formData.price,
            stock: formData.stock,
            description: formData.description,
            categoryId: formData.categoryId,
            attributes: formData.attributes,
            images: formData.images.map(img => ({
                name: img.name,
                size: img.size,
                type: img.type,
                lastModified: img.lastModified
            }))
        };
        
        console.log(JSON.stringify(jsonData, null, 2));
        console.log('Image files count:', imageFiles.length);
        console.log('Image files:', imageFiles);
        console.log('========================');
        
        // Start the save process
        saveProduct(formData);
    }
    
    // Save product with full flow
    async function saveProduct(formData) {
        try {
            console.log('🚀 Starting product save process...');
            
            // Step 1: Create product
            console.log('📦 Step 1: Creating product...');
            const productData = {
                name: formData.name,
                description: formData.description,
                price: formData.price,
                stock: formData.stock,
                categoryId: formData.categoryId
            };
            
            const productResponse = await $.ajax({
                url: '/api/products',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(productData)
            });
            
            if (!productResponse.success) {
                throw new Error(productResponse.message || 'Failed to create product');
            }
            
            const productId = productResponse.data.id;
            console.log('✅ Product created successfully:', productId);
            
            // Step 2: Save attributes
            if (formData.attributes && formData.attributes.length > 0) {
                console.log('🏷️ Step 2: Saving attributes...');
                for (const attribute of formData.attributes) {
                    try {
                        const attributeData = {
                            productId: productId,
                            name: attribute.key,
                            value: attribute.value
                        };
                        
                        const attributeResponse = await $.ajax({
                            url: '/api/product-attributes',
                            method: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(attributeData)
                        });
                        
                        if (attributeResponse.success) {
                            console.log('✅ Attribute saved:', attribute.key, '=', attribute.value);
                        } else {
                            console.warn('⚠️ Failed to save attribute:', attribute.key, attributeResponse.message);
                        }
                    } catch (error) {
                        console.error('❌ Error saving attribute:', attribute.key, error);
                    }
                }
            }
            
            // Step 3: Upload images and save to database
            if (formData.imageFiles && formData.imageFiles.length > 0) {
                console.log('🖼️ Step 3: Uploading images...');
                for (let i = 0; i < formData.imageFiles.length; i++) {
                    try {
                        const file = formData.imageFiles[i];
                        console.log(`Uploading image ${i + 1}/${formData.imageFiles.length}:`, file.name);
                        
                        // Upload to Cloudinary
                        const formDataUpload = new FormData();
                        formDataUpload.append('image', file);
                        
                        const uploadResponse = await $.ajax({
                            url: '/api/cloudinary',
                            method: 'POST',
                            data: formDataUpload,
                            processData: false,
                            contentType: false
                        });
                        
                        console.log('Cloudinary response:', uploadResponse);
                        
                        // CloudinaryController now returns ApiResponse format
                        if (uploadResponse.success && uploadResponse.data && uploadResponse.data.url) {
                            // Save image URL to database
                            const imageData = {
                                productId: productId,
                                imageUrl: uploadResponse.data.url
                            };
                            
                            const imageResponse = await $.ajax({
                                url: '/api/product-images',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify(imageData)
                            });
                            
                            if (imageResponse.success) {
                                console.log('✅ Image saved:', uploadResponse.data.url);
                            } else {
                                console.warn('⚠️ Failed to save image to database:', imageResponse.message);
                            }
                        } else {
                            console.warn('⚠️ Failed to upload image:', uploadResponse.message);
                        }
                    } catch (error) {
                        console.error('❌ Error uploading image:', error);
                    }
                }
            }
            
            // Success!
            console.log('🎉 Product save process completed!');
            showToast('Sản phẩm đã được tạo thành công!', 'success');
            
            // Reset form
            resetForm();
            
        } catch (error) {
            console.error('❌ Error in save process:', error);
            showToast('Lỗi khi tạo sản phẩm: ' + (error.message || 'Lỗi không xác định'), 'error');
        }
    }
    
    // Reset form after successful save
    function resetForm() {
        // Reset all form fields
        $('input[type="text"], input[type="number"], textarea').val('');
        $('#categorySelect').val('');
        
        // Clear attributes
        $('#attributesContainer').empty();
        attributeCount = 0;
        addNewAttribute(); // Add default attribute
        
        // Clear images
        $('#imageInput').val('');
        $('#imagePreviewContainer').addClass('hidden');
        $('#imagePreviewGrid').empty();
        
        console.log('Form reset completed');
    }
    
    // Load categories from API
    function loadCategories() {
        console.log('Loading categories...');
        
        try {
            $.ajax({
                url: '/api/categories',
                method: 'GET',
                success: function(result) {
                    console.log('Categories loaded:', result);
                    
                    if (result.success && result.data && result.data.items && result.data.items.length > 0) {
                        console.log('Displaying categories with count:', result.data.items.length);
                        displayCategories(result.data.items);
                    } else {
                        console.log('No categories found');
                        showCategoriesError();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading categories:', error);
                    showCategoriesError();
                }
            });
        } catch (error) {
            console.error('Error in loadCategories:', error);
            showCategoriesError();
        }
    }
    
    // Display categories in select dropdown
    function displayCategories(categories) {
        console.log('Displaying categories:', categories);
        
        const $select = $('#categorySelect');
        let html = '<option value="">Chọn danh mục</option>';
        
        categories.forEach(function(category) {
            html += `<option value="${category.id}">${category.name}</option>`;
        });
        
        $select.html(html);
        console.log('Categories loaded into select dropdown');
    }
    
    // Show categories error
    function showCategoriesError() {
        const $select = $('#categorySelect');
        $select.html('<option value="">Không thể tải danh mục</option>');
        $select.prop('disabled', true);
    }
    
    // Initialize image upload functionality
    function initImageUpload() {
        const $imageInput = $('#imageInput');
        const $previewContainer = $('#imagePreviewContainer');
        const $previewGrid = $('#imagePreviewGrid');
        const $clearAllBtn = $('#clearAllImages');
        
        let selectedFiles = [];
        
        // File input change
        $imageInput.change(function(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });
        
        // Clear all images
        $clearAllBtn.click(function() {
            selectedFiles = [];
            $imageInput.val('');
            $previewContainer.addClass('hidden');
            $previewGrid.empty();
            console.log('All images cleared');
        });
        
        // Handle selected files
        function handleFiles(files) {
            console.log('Files selected:', files.length);
            
            // Filter only image files
            const imageFiles = files.filter(file => file.type.startsWith('image/'));
            
            if (imageFiles.length === 0) {
                showToast('Vui lòng chọn file hình ảnh hợp lệ!', 'error');
                return;
            }
            
            // Always replace selected files with new ones (prevent accumulation)
            selectedFiles = imageFiles;
            console.log('Replacing files with new selection');
            
            // Update file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            $imageInput[0].files = dt.files;
            
            // Show previews
            showImagePreviews();
            
            console.log('Total selected files:', selectedFiles.length);
        }
        
        // Show image previews
        function showImagePreviews() {
            $previewGrid.empty();
            
            // Update image count
            $('#imageCount').text(selectedFiles.length);
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileSize = (file.size / 1024 / 1024).toFixed(1);
                    const previewHtml = `
                        <div class="relative group bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-all duration-200">
                            <div class="aspect-square relative">
                                <img src="${e.target.result}" alt="Preview ${index + 1}" 
                                     class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-200"></div>
                                <button type="button" class="remove-image-btn absolute top-2 right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs hover:bg-red-600 transition-all duration-200 opacity-0 group-hover:opacity-100 shadow-lg" 
                                        data-index="${index}">
                                    <i class="fas fa-times"></i>
                                </button>
                                <div class="absolute bottom-2 left-2 right-2">
                                    <div class="bg-white bg-opacity-90 backdrop-blur-sm rounded-lg px-2 py-1">
                                        <div class="text-xs font-medium text-gray-800 truncate">${file.name}</div>
                                        <div class="text-xs text-gray-500">${fileSize} MB</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    $previewGrid.append(previewHtml);
                };
                reader.readAsDataURL(file);
            });
            
            $previewContainer.removeClass('hidden');
        }
        
        // Remove individual image
        $(document).on('click', '.remove-image-btn', function() {
            const index = parseInt($(this).data('index'));
            selectedFiles.splice(index, 1);
            
            // Update file input
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            $imageInput[0].files = dt.files;
            
            if (selectedFiles.length === 0) {
                $previewContainer.addClass('hidden');
            } else {
                showImagePreviews();
            }
            
            console.log('Image removed, remaining:', selectedFiles.length);
        });
    }
    
    // Show toast notification
    function showToast(message, type = 'success') {
        const toastId = 'toast-' + Date.now();
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        const icon = type === 'success' ? 'fas fa-check' : type === 'error' ? 'fas fa-times' : 'fas fa-info';
        
        const toastHtml = `
            <div id="${toastId}" class="fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-all duration-300 max-w-sm">
                <div class="flex items-center">
                    <i class="${icon} mr-2 flex-shrink-0"></i>
                    <span class="text-sm">${message}</span>
                </div>
            </div>
        `;
        
        $('body').append(toastHtml);
        
        // Show toast immediately
        setTimeout(() => {
            $(`#${toastId}`).removeClass('translate-x-full');
        }, 50);
        
        // Hide toast after 2.5 seconds
        setTimeout(() => {
            $(`#${toastId}`).addClass('translate-x-full');
            setTimeout(() => {
                $(`#${toastId}`).remove();
            }, 300);
        }, 2500);
    }
});
</script>
